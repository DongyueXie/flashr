<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>More advanced flash usage • flashr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="More advanced flash usage">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">flashr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/stephenslab/flashr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>More advanced flash usage</h1>
                        <h4 class="author">Matthew Stephens</h4>
            
            <h4 class="date">September 23, 2017</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette is designed to describe some more advanced use of flash. Most users should start with the <a href="flash_intro.html" class="uri">flash_intro.html</a> vignette.</p>
<p>The interface described may change as we develop <code>flashr</code>.</p>
</div>
<div id="simulate-data" class="section level1">
<h1 class="hasAnchor">
<a href="#simulate-data" class="anchor"></a>Simulate Data</h1>
<p>We start by simulating some data to provide an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(flashr)
<span class="kw">set.seed</span>(<span class="dv">1</span>)
n =<span class="st"> </span><span class="dv">100</span>
p =<span class="st"> </span><span class="dv">500</span>
k =<span class="st"> </span><span class="dv">7</span>
LL =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(n<span class="op">*</span>k),<span class="dt">nrow=</span>n)
FF =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(p<span class="op">*</span>k),<span class="dt">nrow=</span>p)
Y =<span class="st"> </span>LL <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(FF) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n<span class="op">*</span>p)</code></pre></div>
</div>
<div id="setting-up-data" class="section level1">
<h1 class="hasAnchor">
<a href="#setting-up-data" class="anchor"></a>Setting up data</h1>
<p>For anything beyond the simplest usage, you should start your analysis by setting up the data in what we will call a “flash data object”. This is essentially simply an n by p matrix, but with meta-data to allow <code>flash</code> functions to deal properly with missing values etc. (This framework also makes it easier for future extensions to pass more information in as data; e.g. maybe variances also associated with the matrix).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data =<span class="st"> </span><span class="kw"><a href="../reference/flash_set_data.html">flash_set_data</a></span>(Y)</code></pre></div>
</div>
<div id="initializing-a-factor-model" class="section level1">
<h1 class="hasAnchor">
<a href="#initializing-a-factor-model" class="anchor"></a>Initializing a factor model</h1>
<p>Second, we need to initialize a factor model - essentially a set of factors and loadings. We call this a “flash fit object”, although at this point it is not actually fit to the data (this is the next step!) There are several ways to do this, using functions of the form <code>flash_add_xxx</code>. They are called this because they can add factors to an existing flash fit object—by providing a value for the argument <code>f_init</code>—so you can build up a flash fit object bit-by-bit. Here we have no existing flash fit object, so we do not specify <code>f_init</code>, and in this case these functions create a new fit object.</p>
<p>For illustration we show <code>flash_add_factors_from_data</code>. This essentially runs <code>softImpute</code> (soft-thresholded singular value decomposition) on the data to obtain an initial set of factors and loadings. We have to choose a number of factors to initialize with. (Factors can be dropped out during the fit so ideally this should be a larger number than we think we actually need; but at the same time more factors mean more computation, so you might start with a moderate number, and then try increasing later if the data seem to warrant it.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f =<span class="st"> </span><span class="kw"><a href="../reference/flash_add_factors_from_data.html">flash_add_factors_from_data</a></span>(data,<span class="dt">K=</span><span class="dv">10</span>)</code></pre></div>
</div>
<div id="refiningfitting-a-factor-model" class="section level1">
<h1 class="hasAnchor">
<a href="#refiningfitting-a-factor-model" class="anchor"></a>Refining/fitting a factor model</h1>
<p>Once you have initialized a flash fit object, you can improve the fit using <code>flash_backfit</code>. (If you want to see how the fit is progressing, set <code>verbose=TRUE</code> here.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f =<span class="st"> </span><span class="kw"><a href="../reference/flash_backfit.html">flash_backfit</a></span>(data,f,<span class="dt">verbose=</span><span class="ot">FALSE</span>)</code></pre></div>
</div>
<div id="extracting-information" class="section level1">
<h1 class="hasAnchor">
<a href="#extracting-information" class="anchor"></a>Extracting information</h1>
<p>Having fit the model we might want to extract the fitted factors and loadings. You can do that using functions like <code>flash_get_ldf</code> to get the standardized loadings, factors and weights. Also <code>flash_get_lf</code> gets the product (LDF’). And <code>flash_get_objective</code> will return the measure of goodness-of-fit achieved (the variational lower bound, F). This can be helpful for comparing multiple fits to the same data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw"><a href="../reference/flash_get_lf.html">flash_get_lf</a></span>(f), LL <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(FF),
     <span class="dt">main=</span><span class="st">"compare fitted values with true LF'"</span>)</code></pre></div>
<p><img src="flash_advanced_files/figure-html/unnamed-chunk-5-1.png" width="480" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/flash_get_ldf.html">flash_get_ldf</a></span>(f)<span class="op">$</span>d
<span class="co"># [1] 303.3382 264.0119 242.3772 217.6895 208.5868 205.8112 183.3776</span>
<span class="kw"><a href="../reference/flash_get_objective.html">flash_get_objective</a></span>(data,f)
<span class="co"># [1] -81253.75</span></code></pre></div>
</div>
<div id="greedy-addition-of-factors" class="section level1">
<h1 class="hasAnchor">
<a href="#greedy-addition-of-factors" class="anchor"></a>Greedy addition of factors</h1>
<p>The way we did it above was to add all the factors at once and then optimize. An alternative is to add one at a time, and optimize each in turn. This is accomplished using <code>flash_add_greedy</code>. This will keep adding factors until they no longer improve the fit, so you need to specify a maximum number to consider.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f_greedy =<span class="st"> </span><span class="kw"><a href="../reference/flash_add_greedy.html">flash_add_greedy</a></span>(data,<span class="dt">Kmax=</span><span class="dv">10</span>)
<span class="co"># fitting factor/loading 1</span>
<span class="co"># fitting factor/loading 2</span>
<span class="co"># fitting factor/loading 3</span>
<span class="co"># fitting factor/loading 4</span>
<span class="co"># fitting factor/loading 5</span>
<span class="co"># fitting factor/loading 6</span>
<span class="co"># fitting factor/loading 7</span>
<span class="co"># fitting factor/loading 8</span>
<span class="kw"><a href="../reference/flash_get_ldf.html">flash_get_ldf</a></span>(f_greedy)<span class="op">$</span>d
<span class="co"># [1] 292.3761 253.6873 233.4289 210.8591 204.2400 203.0717 182.1317</span>
<span class="kw"><a href="../reference/flash_get_objective.html">flash_get_objective</a></span>(data,f_greedy)
<span class="co"># [1] -84068.31</span></code></pre></div>
<p>After adding factors in this way you can use backfitting to try to further improve the fit. In our experience, for different datasets, sometimes this provides a better fit than initializing all at once (as in <code>f</code> above), sometimes worse.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f_greedy_bf =<span class="st"> </span><span class="kw"><a href="../reference/flash_backfit.html">flash_backfit</a></span>(data,f_greedy)
<span class="kw"><a href="../reference/flash_get_ldf.html">flash_get_ldf</a></span>(f_greedy_bf)<span class="op">$</span>d
<span class="co"># [1] 303.7844 263.2466 241.8200 217.4748 209.0290 206.0587 183.2006</span>
<span class="kw"><a href="../reference/flash_get_objective.html">flash_get_objective</a></span>(data,f_greedy_bf)
<span class="co"># [1] -81264.89</span>
<span class="kw"><a href="../reference/flash_get_objective.html">flash_get_objective</a></span>(data,f)
<span class="co"># [1] -81253.75</span></code></pre></div>
</div>
<div id="setting-loadings-and-factors-directly" class="section level1">
<h1 class="hasAnchor">
<a href="#setting-loadings-and-factors-directly" class="anchor"></a>Setting loadings and factors directly</h1>
<p>In simulation experiments it might be useful to initialize the loadings and factors to the “truth” to see how it affects the convergence.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f_true =<span class="st"> </span><span class="kw"><a href="../reference/flash_add_lf.html">flash_add_lf</a></span>(data, <span class="dt">LL=</span>LL, <span class="dt">FF=</span>FF)
f_cheat =<span class="st"> </span><span class="kw"><a href="../reference/flash_backfit.html">flash_backfit</a></span>(data,f_true)
<span class="kw"><a href="../reference/flash_get_ldf.html">flash_get_ldf</a></span>(f_cheat)<span class="op">$</span>d
<span class="co"># [1] 208.6823 214.9714 250.2059 213.0661 284.4945 221.1514 236.8675</span>
<span class="kw"><a href="../reference/flash_get_objective.html">flash_get_objective</a></span>(data,f_cheat)
<span class="co"># [1] -81306.46</span></code></pre></div>
<p>Unexpectedly (to me) the objective achieved from this initialization is lower than those from the greedy initialization. However, the results are pretty similar in terms of mean squared error (MSE). Notice that backfitting improved MSE vs greedy.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>((<span class="kw"><a href="../reference/flash_get_lf.html">flash_get_lf</a></span>(f_cheat) <span class="op">-</span><span class="st"> </span>LL <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(FF))<span class="op">^</span><span class="dv">2</span>)
<span class="co"># [1] 0.08423822</span>
<span class="kw">mean</span>((<span class="kw"><a href="../reference/flash_get_lf.html">flash_get_lf</a></span>(f_greedy_bf) <span class="op">-</span><span class="st"> </span>LL <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(FF))<span class="op">^</span><span class="dv">2</span>)
<span class="co"># [1] 0.08411568</span>
<span class="kw">mean</span>((<span class="kw"><a href="../reference/flash_get_lf.html">flash_get_lf</a></span>(f) <span class="op">-</span><span class="st"> </span>LL <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(FF))<span class="op">^</span><span class="dv">2</span>)
<span class="co"># [1] 0.08426771</span>
<span class="kw">mean</span>((<span class="kw"><a href="../reference/flash_get_lf.html">flash_get_lf</a></span>(f_greedy) <span class="op">-</span><span class="st"> </span>LL <span class="op">%*%</span><span class="st"> </span><span class="kw">t</span>(FF))<span class="op">^</span><span class="dv">2</span>)
<span class="co"># [1] 0.09737634</span></code></pre></div>
</div>
<div id="setting-the-function-used-to-solve-the-ebnm-problem" class="section level1">
<h1 class="hasAnchor">
<a href="#setting-the-function-used-to-solve-the-ebnm-problem" class="anchor"></a>Setting the function used to solve the EBNM problem</h1>
<p>The flash algorithm involves iteratively applying a function that solves the “Empirical Bayes normal means” (EBNM) problem. See Wang and Stephens (2017) for more details on this. The <code>flashr</code> package provides two functions to do this: <code>ebnm_pn</code>, which uses a point-normal prior from the <code>ebnm</code> package, and <code>ebnm_ash</code> which provides an interface to functions in the <code>ashr</code> package.</p>
<p>In principle the <code>ebnm_ash</code> function fits a more flexible model, so might be preferred. However, in the paper we generally found the two methods give similar average performance, and <code>ebnm_pn</code> is (currently) faster, and so this is the default.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f_greedy_ash =<span class="st"> </span><span class="kw"><a href="../reference/flash_add_greedy.html">flash_add_greedy</a></span>(data,<span class="dt">Kmax=</span><span class="dv">10</span>,<span class="dt">ebnm_fn =</span> ebnm_ash)
<span class="co"># fitting factor/loading 1</span>
<span class="co"># fitting factor/loading 2</span>
<span class="co"># fitting factor/loading 3</span>
<span class="co"># fitting factor/loading 4</span>
<span class="co"># fitting factor/loading 5</span>
<span class="co"># fitting factor/loading 6</span>
<span class="co"># fitting factor/loading 7</span>
<span class="co"># fitting factor/loading 8</span>
<span class="kw"><a href="../reference/flash_get_objective.html">flash_get_objective</a></span>(data,f_greedy_ash)
<span class="co"># [1] -84075.06</span></code></pre></div>
</div>
<div id="fixed-factors-or-loadings" class="section level1">
<h1 class="hasAnchor">
<a href="#fixed-factors-or-loadings" class="anchor"></a>Fixed factors or loadings</h1>
<p>Sometimes you might want to include a “fixed” factor or loading in the analysis. For example, maybe you have a covariate you are interested in the effect of. Or you want to include a mean term in the rows or columns. You can add such “fixed” factors using <code>flash_add_fixed_l</code> or <code>flash_add_fixed_f</code>. Fixed loadings will not be updated during a subsequent fit, but their corresponding factors <em>will</em> be updated. Similarly, fixed factors will not be updated, but their loadings will be. (Missing values, NA, in a fixed loading or factor are allowed and will be updated during a fit.)</p>
<p>For example, the following creates a flash fit object with a fixed intercept loading. (So when fit it will estimate a corresponding factor, which should be interpreted as a column-specific mean.) Then it adds 10 data-based factors and loadings, and then it fits the model. Note how the first loading (the mean) does not change during the fit. (Notice also that the corresponding factor is 0—correct since we did not add a non-zero mean to the simulation.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f =<span class="st"> </span><span class="kw"><a href="../reference/flash_add_fixed_l.html">flash_add_fixed_l</a></span>(data,<span class="dt">LL =</span> <span class="kw">cbind</span>(<span class="kw">rep</span>(<span class="dv">1</span>,n)))
f =<span class="st"> </span><span class="kw"><a href="../reference/flash_add_factors_from_data.html">flash_add_factors_from_data</a></span>(data,<span class="dt">K=</span><span class="dv">10</span>,<span class="dt">f_init=</span>f)
f =<span class="st"> </span><span class="kw"><a href="../reference/flash_backfit.html">flash_backfit</a></span>(data,f)
<span class="kw"><a href="../reference/flash_get_k.html">flash_get_k</a></span>(f) <span class="co">#tells you how many factors f has</span>
<span class="co"># [1] 11</span>
<span class="kw">head</span>(<span class="kw"><a href="../reference/flash_get_ldf.html">flash_get_ldf</a></span>(f,<span class="dv">1</span>,<span class="dt">drop_zero_factors =</span> <span class="ot">FALSE</span>)<span class="op">$</span>l)
<span class="co">#      [,1]</span>
<span class="co"># [1,]  0.1</span>
<span class="co"># [2,]  0.1</span>
<span class="co"># [3,]  0.1</span>
<span class="co"># [4,]  0.1</span>
<span class="co"># [5,]  0.1</span>
<span class="co"># [6,]  0.1</span>
<span class="co"># Note this is 0 as the factor has no weight</span>
<span class="kw"><a href="../reference/flash_get_ldf.html">flash_get_ldf</a></span>(f,<span class="dv">1</span>,<span class="dt">drop_zero_factors =</span> <span class="ot">FALSE</span>)<span class="op">$</span>d
<span class="co"># [1] 0</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#simulate-data">Simulate Data</a></li>
      <li><a href="#setting-up-data">Setting up data</a></li>
      <li><a href="#initializing-a-factor-model">Initializing a factor model</a></li>
      <li><a href="#refiningfitting-a-factor-model">Refining/fitting a factor model</a></li>
      <li><a href="#extracting-information">Extracting information</a></li>
      <li><a href="#greedy-addition-of-factors">Greedy addition of factors</a></li>
      <li><a href="#setting-loadings-and-factors-directly">Setting loadings and factors directly</a></li>
      <li><a href="#setting-the-function-used-to-solve-the-ebnm-problem">Setting the function used to solve the EBNM problem</a></li>
      <li><a href="#fixed-factors-or-loadings">Fixed factors or loadings</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matthew Stephens, Wei Wang, Jason Willwerscheid.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
